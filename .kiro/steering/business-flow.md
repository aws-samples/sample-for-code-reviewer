# 业务流程与配置详情

## 评审规则处理
- **多规则执行**: 所有匹配`branch`字段的`.codereview/*.yaml`文件独立处理
- **无优先级系统**: 规则并行执行，无优先级排序 - 完成顺序无关紧要
- **分支匹配**: 每个规则包含`branch`字段，确定规则是否适用于当前分支
- **结果聚合**: 所有规则结果合并到最终报告中，不考虑完成顺序
- **冲突处理**: 当多个规则对同一代码段提供冲突建议时，所有建议都包含在报告中供用户审查和决策

## 评审模式与触发器

### 触发源
1. **WebTool手动触发**: 用户通过Web界面指定评审模式
2. **仓库Webhook事件**: 基于git事件自动触发，模式由仓库配置决定

### 评审模式
- **diff**: 仅评审提交间变更的文件
- **single**: 分别评审单个文件
- **all**: 评审整个仓库代码库

### 模式选择逻辑
- WebTool请求包含明确的模式参数
- 仓库hook将事件类型与DynamoDB `{project_name}-repository`表中的规则进行比较
- 配置匹配分支模式和事件类型 (push/merge_request) 来确定模式

## 模块化评审配置
- **基于目标的模块**: 在规则文件中使用`target`字段指定文件路径模式
- **Glob模式支持**: 支持标准glob模式
  - `*`: 匹配单层目录中的任意字符(不包含/)
  - `**`: 匹配多层目录
  - `?`: 匹配单个字符
  - 通过match_glob_pattern函数实现，转换为正则表达式匹配
- **大型项目策略**: 按模块将大型代码库分解为可管理的评审块


## 自定义提示系统
- **System字段**: 每个规则文件支持`system`字段用于自定义Claude系统提示
- **规则特定提示**: 不同规则可以有不同的系统提示以专注特定评审
- **默认行为**: 如果未提供system字段，使用默认Claude行为

## 配置初始化
- **repos.json**: 定义DynamoDB设置的初始仓库配置
- **rules.json**: 包含常见场景的默认评审规则
- **data_initializer.py**: 在部署期间将两个JSON文件处理到DynamoDB表中
- **Repository表**: 存储分支模式和事件到模式的映射
- **Rule表**: 存储默认评审规则模板

## 超时与错误处理
- **15分钟超时**: 通过EventBridge每分钟触发cron函数检查，超时时间可配置(REPORT_TIMEOUT_SECONDS环境变量)
- **定时任务配置**: 在lib/cron-stack.ts中使用events.Schedule.rate(cdk.Duration.minutes(1))设置，可调整检查频率
- **部分结果**: 超时报告包含所有已完成任务的结果
- **独立任务执行**: 失败的任务不会阻塞其他任务完成
- **进度跟踪**: 通过DynamoDB和`/result` API端点进行实时状态跟踪
- **Web工具轮询**: 每1秒轮询/result API端点获取任务状态，实时显示任务详细状态

## 任务处理流程
1. **请求处理器**: 接收webhook，在DynamoDB中创建请求记录
2. **任务分发器**: 将请求分解为单个Bedrock任务，通过递增计数器生成任务number，发送到SQS
3. **任务执行器**: 消费SQS消息，支持并行执行，多个Lambda实例可同时处理不同任务
4. **进度检查器**: 监控整体请求完成状态
5. **报告生成器**: 当所有任务完成或发生超时时聚合结果
6. **通知**: 通过SNS向配置的接收者发送最终报告

## 重试和错误处理
- **Bedrock重试机制**: 通过环境变量配置
  - SQS_MAX_RETRIES=5 (最大重试次数)
  - SQS_BASE_DELAY=2 (基础延迟秒数)
  - SQS_MAX_DELAY=60 (最大延迟秒数)
  - MAX_FAILED_TIMES=6 (最大失败次数)
  - 使用指数退避策略，失败后重新发送到SQS队列延迟处理