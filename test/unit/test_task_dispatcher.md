# test_task_dispatcher.py 测试用例设计文档

## 模块概述

`task_dispatcher.py` 是代码评审系统的核心调度模块，负责将一个代码评审请求分解成多个具体的AI评审任务。它是连接请求处理和任务执行的关键桥梁，承担着任务分发、状态管理和内容组织的重要职责。

## 业务流程分析

### 主要业务步骤
1. **事件验证** - 验证SQS事件的必要字段
2. **上下文初始化** - 获取仓库信息和格式化commit ID
3. **规则加载** - 从仓库或webtool获取评审规则
4. **规则过滤** - 根据分支和事件类型筛选适用规则
5. **内容获取** - 根据模式(all/single/diff)获取代码内容
6. **任务生成** - 将内容与规则组合生成Bedrock任务
7. **任务分发** - 将任务发送到SQS队列
8. **状态更新** - 更新DynamoDB中的请求状态

### 关键业务逻辑
- **多规则并行处理**：所有匹配的规则都会独立执行
- **模式差异化处理**：all/single/diff三种模式的内容获取策略不同
- **智能提示词生成**：支持自定义和默认两种提示词构造方式
- **容错机制**：任务发送失败时的错误处理和状态更新

## 测试用例设计

### 1. 事件验证测试 (test_validate_sqs_event)

#### 测试目标
验证输入事件的完整性和格式正确性，确保后续处理的数据基础可靠。

#### 测试场景
- **正常事件**：包含所有必要字段的标准SQS事件
- **缺失必要字段**：缺少request_id字段的无效事件
- **字段类型错误**：字段存在但类型不匹配的事件
- **空事件**：完全空的事件对象

#### 测试流程
1. 准备不同类型的测试事件数据
2. 调用validate_sqs_event函数
3. 验证正常事件通过验证
4. 验证异常事件抛出预期异常

#### 关键验证点
- 必要字段的存在性检查
- 异常信息的准确性
- 验证逻辑的完整性

#### 期望结果
- 有效事件返回True
- 无效事件抛出包含具体错误信息的异常

### 2. 规则加载测试 (test_load_rules)

#### 测试目标
验证评审规则的正确加载，包括webtool和webhook两种触发方式的规则构造。

#### 测试场景
- **Webtool触发**：通过Web界面手动触发的评审请求
- **Webhook触发**：通过仓库事件自动触发的评审请求
- **多规则仓库**：包含多个.codereview文件的仓库
- **空规则仓库**：没有评审规则的仓库

#### 测试流程
1. Mock GitLab Project对象，让其repository_tree和files.raw方法返回预设的规则文件数据
2. 构造webtool和webhook两种类型的事件
3. 调用load_rules函数（内部会调用codelib.get_rules，该函数真实执行）
4. 验证返回的规则数据结构和内容

#### 关键验证点
- Webtool规则的正确构造
- Webhook规则的正确加载
- 规则字段的完整性
- 异常情况的处理

#### 期望结果
- Webtool模式返回单个构造的规则
- Webhook模式返回从仓库加载的规则列表

### 3. 规则过滤测试 (test_filter_rules)

#### 测试目标
验证规则过滤逻辑，确保只有匹配当前分支和事件类型的规则被执行。

#### 测试场景
- **完全匹配**：分支和事件类型都匹配的规则
- **分支不匹配**：分支名不匹配的规则
- **事件不匹配**：事件类型不匹配的规则
- **都不匹配**：分支和事件都不匹配的规则
- **多规则混合**：部分匹配部分不匹配的规则集合

#### 测试流程
1. 准备包含不同分支和事件类型的规则集合
2. 设置特定的target_branch和event_type
3. 执行规则过滤逻辑
4. 验证只有匹配的规则被保留

#### 关键验证点
- 分支匹配逻辑的准确性
- 事件类型匹配的正确性
- 过滤结果的完整性

#### 期望结果
- 只返回同时匹配分支和事件类型的规则
- 过滤后的规则数量正确

### 4. 内容获取测试 (test_get_code_contents)

#### 测试目标
验证三种评审模式(all/single/diff)的内容获取逻辑，确保每种模式都能正确获取对应的代码内容。

#### 测试场景

##### 4.1 All模式测试
- **完整项目**：获取整个项目的代码文本
- **目标过滤**：根据target字段过滤特定文件
- **空项目**：没有代码文件的项目
- **大型项目**：包含大量文件的项目

##### 4.2 Single模式测试
- **单文件变更**：只有一个文件发生变更
- **多文件变更**：多个文件同时变更
- **新增文件**：包含新增文件的变更
- **删除文件**：包含删除文件的变更

##### 4.3 Diff模式测试
- **简单差异**：少量行的修改
- **大量差异**：大规模的代码变更
- **二进制文件**：包含二进制文件的差异
- **重命名文件**：文件重命名的处理

#### 测试流程
1. Mock GitLab Project对象的相关方法（repository_compare, files.raw, repository_tree）返回预设的文件和内容数据
2. 为每种模式准备对应的测试规则
3. 调用对应的内容获取函数（内部调用codelib函数，但codelib函数真实执行）
4. 验证返回的内容结构和格式

#### 关键验证点
- 内容格式的正确性
- 文件路径的准确性
- 目标过滤的有效性
- 模式特定逻辑的正确性

#### 期望结果
- All模式返回完整项目代码
- Single模式返回每个文件的完整内容
- Diff模式返回文件的差异内容

### 5. 提示词生成测试 (test_prompt_generation)

#### 测试目标
验证AI模型提示词的生成逻辑，包括自定义提示词和默认提示词两种方式。

#### 测试场景
- **自定义提示词**：使用prompt_system和prompt_user字段
- **默认提示词**：使用system字段和其他字段组合
- **变量替换**：包含{{variable}}格式的变量替换
- **字段排序**：使用order字段控制字段顺序
- **空提示词**：提示词为空的处理

#### 测试流程
1. 准备包含不同提示词配置的规则
2. 准备包含变量的测试数据
3. 调用get_prompt_data函数
4. 验证生成的提示词内容和格式

#### 关键验证点
- 提示词内容的正确性
- 变量替换的准确性
- 字段排序的有效性
- 空值处理的合理性

#### 期望结果
- 自定义提示词按配置生成
- 默认提示词按字段顺序组合
- 变量正确替换为实际值

### 6. 任务分发测试 (test_task_distribution)

#### 测试目标
验证任务数据的正确构造和SQS消息的成功发送。

#### 测试场景
- **单任务发送**：发送单个Bedrock任务
- **批量任务发送**：同时发送多个任务
- **任务数据完整性**：验证任务包含所有必要字段
- **Base64编码**：验证消息体的编码格式
- **发送失败处理**：SQS发送失败的错误处理

#### 测试流程
1. 使用真实的SQS测试队列（不Mock SQS客户端）
2. 准备测试内容和规则数据
3. 调用send_task_to_sqs函数
4. 直接从SQS队列读取消息验证发送的内容和格式

#### 关键验证点
- 任务数据结构的完整性
- SQS消息格式的正确性
- 发送失败时的错误处理
- 任务计数的准确性

#### 期望结果
- 任务成功发送到SQS队列
- 消息内容包含完整的任务信息
- 发送失败时正确更新失败计数

### 7. 状态管理测试 (test_status_management)

#### 测试目标
验证DynamoDB中请求状态的正确更新和管理。

#### 测试场景
- **状态初始化**：将请求状态设置为Initializing
- **任务计数更新**：更新task_total、task_complete、task_failure
- **完成状态设置**：当没有任务时直接设置为完成
- **并发更新**：多个操作同时更新状态
- **更新失败处理**：DynamoDB操作失败的处理

#### 测试流程
1. 使用真实的DynamoDB测试表
2. 创建测试请求记录
3. 执行状态更新操作
4. 直接读取数据库验证更新结果

#### 关键验证点
- 状态字段的正确更新
- 时间戳的准确记录
- 计数字段的数值正确性
- 异常情况的处理

#### 期望结果
- 数据库记录正确更新
- 所有状态字段值准确
- 异常情况得到妥善处理

### 8. 异常处理测试 (test_exception_handling)

#### 测试目标
验证各种异常情况的处理能力，确保系统的健壮性。

#### 测试场景
- **仓库访问失败**：GitLab API调用异常
- **规则解析错误**：.codereview文件格式错误
- **数据库操作失败**：DynamoDB读写异常
- **SQS队列异常**：队列不可用或权限不足
- **内存不足**：处理大型项目时的资源限制

#### 测试流程
1. Mock GitLab Project对象的方法抛出异常（如GitlabGetError、GitlabAuthenticationError）
2. 执行lambda_handler函数
3. 验证异常被正确捕获和处理
4. 检查错误日志和返回值

#### 关键验证点
- 异常捕获的完整性
- 错误信息的准确性
- 系统状态的一致性
- 日志记录的详细性

#### 期望结果
- 异常被正确捕获和处理
- 返回适当的错误响应
- 系统状态保持一致

### 9. 边界条件测试 (test_boundary_conditions)

#### 测试目标
验证系统在极端条件下的行为表现。

#### 测试场景
- **空仓库**：没有任何代码文件
- **无变更**：commit_id与previous_commit_id相同
- **大量规则**：包含大量评审规则
- **深层目录**：深度嵌套的目录结构
- **特殊字符**：包含特殊字符的文件名和路径

#### 测试流程
1. 构造极端情况的测试数据
2. 执行完整的处理流程
3. 验证系统行为的合理性
4. 检查性能和资源使用

#### 关键验证点
- 空数据的处理
- 性能表现
- 内存使用
- 错误处理

#### 期望结果
- 极端情况得到合理处理
- 系统保持稳定运行
- 性能在可接受范围内

### 10. 集成场景测试 (test_integration_scenarios)

#### 测试目标
验证完整业务流程的端到端正确性。

#### 测试场景
- **完整Webtool流程**：从Web请求到任务分发
- **完整Webhook流程**：从仓库事件到任务分发
- **多规则并行处理**：同一请求匹配多个规则
- **混合模式处理**：不同规则使用不同模式
- **项目名更新**：自动更新不匹配的项目名

#### 测试流程
1. 构造完整的业务场景数据
2. 执行lambda_handler函数
3. 验证整个流程的正确性
4. 检查最终状态和副作用

#### 关键验证点
- 流程完整性
- 数据一致性
- 状态正确性
- 副作用验证

#### 期望结果
- 完整流程正确执行
- 所有组件协调工作
- 最终状态符合预期

## 测试策略

### Mock策略
- **最小化原则**：只Mock真正不可控的外部依赖
- **GitLab Project对象Mock**：Mock gitlab_code.py中的GitLab API调用（project.repository_compare, project.files.raw, project.repository_tree等）
- **AWS服务真实**：DynamoDB、SQS使用真实的测试环境资源
- **业务逻辑真实**：codelib.py、base.py等自定义模块函数不Mock，让核心业务逻辑真实执行

### 验证方法
- **数据库直读**：直接读取DynamoDB验证状态更新
- **SQS消息检查**：验证队列中消息的数量和格式
- **日志分析**：通过日志验证关键逻辑的执行
- **副作用验证**：检查函数执行后的系统状态变化

### 测试数据管理
- **仿真仓库数据**：使用test/mock_data中的版本化数据，通过Mock GitLab Project对象返回这些数据
- **多样化规则**：覆盖各种模式和配置的规则
- **真实场景**：基于实际使用场景的测试数据
- **边界数据**：极端情况下的测试数据

### 环境配置
- **独立测试环境**：使用专门的测试AWS资源
- **环境变量管理**：通过test_config.py统一管理
- **数据隔离**：每个测试使用独立的数据空间
- **自动清理**：测试后自动清理测试数据

## 业务价值

task_dispatcher作为代码评审系统的核心调度模块，其测试的充分性直接关系到：

1. **系统可靠性**：确保任务分发的准确性和完整性
2. **性能表现**：验证大规模项目的处理能力
3. **用户体验**：保证各种使用场景下的正确响应
4. **系统扩展性**：为未来功能扩展提供稳定基础

通过全面的测试覆盖，我们能够确保这个关键模块在生产环境中稳定可靠地运行，为整个代码评审系统提供坚实的基础。

## 测试执行指南

### 本地测试
```bash
# 运行单个测试文件
pytest test/unit/test_task_dispatcher.py -v

# 运行特定测试方法
pytest test/unit/test_task_dispatcher.py::TestTaskDispatcher::test_validate_sqs_event -v

# 运行带覆盖率的测试
pytest test/unit/test_task_dispatcher.py -v --cov=lambda.task_dispatcher --cov-report=html
```

### 环境准备
```bash
# 检查测试环境
python test/check_test_env.py

# 设置环境变量
source test/test_config.py
```

### 调试技巧
- 使用`-s`参数查看详细输出
- 使用`--pdb`参数在失败时进入调试器
- 检查`test/logs/`目录下的详细日志
- 使用AWS控制台验证资源状态